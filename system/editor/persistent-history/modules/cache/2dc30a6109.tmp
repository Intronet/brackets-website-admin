/* {external} */
/*jslint node: true, vars: true, plusplus: true, devel: true, nomen: true, white: true, regexp: true, indent: 2, maxerr: 50

*/
/*global define, $, brackets, Mustache, window, console, Node, CryptoJS,  EJS, getComputedStyle, CodeMirror, $g, g, sT, ip, dev, code, unescape

*/
(function (){  
	"use strict";

	var
		dev= true,
		update = false,
		selfClose = true,
		version;

	//	Glow extension icon
   $.fn.glow = function(options) {    
      var settings = $.extend( {
         // These are the defaults.
         timer: 500,         
         opacity: 0.20,
         color: ['#ffffff','#0083e8']
         }, options );   
      function glow(e,o,c,t){
         $(e).animate({opacity: o, color : c}, t, 
            function() {
               if(o === 1){
                  o = settings.opacity;
                  c = settings.color[1];
               } else {
                  o = 1;
                  c = settings.color[0];
               }
               glow(this,o,c,t); // Animation complete.
           });
      }      
      glow(this, settings.opacity, settings.color[0], settings.timer);
   };

	$("#main-toolbar .buttons")
		.append('<a id="toolbar-brackets-wysiwyg" title="Brackets Website Admin" href="#"><i class="fa fa-html5"><\/i><\/a>');
	$("#toolbar-brackets-wysiwyg").on("click", function () {
		$('#projectInfo select')[0].selectedIndex=1;
		$('#projectInfo select').change();
	}).glow({opacity: 0.7, color:['#91cc41','#769B45'], timer: 1000});

	version = parseInt(($g.EX.extensions["brackets-website-admin"].installInfo.metadata.version).replace(/\./g,''),10);

	if(version < 4) {
		update = true;
		selfClose = false;
	}

	$g.sD('preference-dialog', selfClose, {
		getTab: 7,
		dev: dev,
		welcome: true,
		sT: $g.sT,
		update: update,
		solo: {
			css: "welcome"
		},
		ready: function(){				
		},
		callback: function(){
			$g.DL.cancelModalDialogIfOpen('preference-dialog');
			/*
			console.log('click the extension icon');
			*/
			$('#toolbar-extension-manager').click();
			/*
			console.log("waiting for $('.extension-manager-dialog') to open");
			*/
			var
				tasks = {
					extensionManager: {
						dialog: '.extension-manager-dialog',
						loaded: false,
						element: 'button.update[data-extension-id="brackets-website-admin"]',
						done: false
					},
					installExtension:{
						dialog: '.install-extension-dialog',
						done: false
					},
					changeMarked:{
						dialog: '.change-marked-extensions',
						done: false
					},							
					timer: setInterval(function () {
						if($(tasks.extensionManager.dialog).length !== 0 && tasks.extensionManager.loaded === false) {
							/*
							$(tasks.extensionManager.dialog).parent().parent().hide();
							console.log("OPENED $('.extension-manager-dialog')");
							*/
							tasks.extensionManager.loaded=true;
						}
						if($(tasks.extensionManager.element).length !== 0 && tasks.extensionManager.done === false) { 
							/*
							console.log('done loading');
							*/
							$(tasks.extensionManager.element).click();
							/*
							console.log('click update button');
							*/
							$('.install-extension-dialog:gt(0)').each(function(){
								$(this).parent().parent().remove();
							});
							tasks.extensionManager.done=true;
							/*
							console.log('waiting for download');
							*/
						}
						if($(tasks.installExtension.dialog).length === 1 && tasks.installExtension.done === false){
							/*
							$(tasks.installExtension.dialog).parent().parent().hide();
							*/
							if($(tasks.installExtension.dialog).find(".message:contains('This extension update')").length === 1){
								/*
								console.log('downloaded');
								*/
								$(tasks.installExtension.dialog).find('button[data-button-id="ok"]').click();
								/*
								console.log('close installExtension');
								*/
								$(tasks.extensionManager.dialog).find('button[data-button-id="close"]').click();
								/*
								console.log('close extensionManager');
								*/
							}
						}
						if($(tasks.changeMarked.dialog).length === 1 && tasks.changeMarked.done === false){
								/*
								$(tasks.changeMarked.dialog).parent().parent().hide();
								$(tasks.changeMarked.dialog).find('button[data-button-id="ok"]').click();
								*/
								/*
								console.log('close changeMarked');
								*/
								tasks.changeMarked.done = true;
								/*
								console.log('waiting for reload');
								*/
								clearInterval(tasks.timer);									
						}	
					},100)			
				};	
			setTimeout(function(){
				clearInterval(tasks.timer);
			}, 20000);
		}				
	});

	if(dev === true) {
		/*show develors tools   */
		setTimeout(function () {
			brackets.app.showDeveloperTools();
		},1);
	}		
}());